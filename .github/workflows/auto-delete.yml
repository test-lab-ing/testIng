name: "Robot: Auto Delete Branch"

on:
  # pull_request: # บอกให้บอทคอยเฝ้าดูเหตุการณืที่เกี่ยวกับ pr
  #   types: [closed] # บอกว่าไม่ต้องตื่นตอนเขาสร้าง PR นะ แต่ "ให้ตื่นขึ้นมาทำงานเฉพาะตอนที่มีคนสั่งปิด PR เท่านั้น"
  workflow_call: # เพิ่มเข้ามาเหมือนรอให้คนมาโทร เพื่อทำหน้าที่

jobs:
  auto-delete-branch:
    # เงื่อนไขเพื่อเช็คว่า PR (marge แล้ว) ปิดแล้วเรียบร้อย
    if: github.event.pull_request.merged == true || github.ref_name != 'main' #และเพิ่มเงื่อนไขอีกว่า หรือถ้า branch ที่กำลังทำงานอยู่ ที่ไม่ใช่ main
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: "1. ตรวจสอบชื่อ branch ที่จะลบ"
        run: |
          TARGET="${{ github.event.pull_request.head.ref || github.ref_name }}"
          echo "PR ถูก Merge แล้ว! กำลังเตรียมลบ branch: $TARGET"
          
          # ป้องกันไม่ให้ลบกิ่งหลัก (เผื่อไว้)
          if [ "$TARGET" == "main" ] || [ "$TARGET" == "develop" ]; then
            echo "ไม่สามารถลบกิ่งหลักได้"
            exit 1
          fi
          echo "target_branch=$TARGET" >> $GITHUB_ENV

      - name: "2. สั่งลบ branch อัตโนมัติ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X DELETE "/repos/${{ github.repository }}/git/refs/heads/${{ env.target_branch }}"