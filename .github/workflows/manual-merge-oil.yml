name: "Robot: Manual Merge Pull Request"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'à¸£à¸°à¸šà¸¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚ Pull Request (à¹€à¸Šà¹ˆà¸™ 12)'
        required: true
        type: number

      merge_method:
        description: 'à¸§à¸´à¸˜à¸µ merge'
        required: true
        type: choice
        options:
          - squash
          - merge
          - rebase

permissions:
  pull-requests: write
  contents: write
  issues: write  # <--- [à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸] à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸¢à¸¸à¹ˆà¸‡à¸à¸±à¸š Issue à¸”à¹‰à¸§à¸¢

jobs:
  manual-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¸ªà¸±à¹ˆà¸‡
        run: |
          echo "ðŸ”§ à¸à¸³à¸¥à¸±à¸‡à¸ˆà¸° merge PR #${{ github.event.inputs.pr_number }}"
          echo "âž¡ï¸ à¸§à¸´à¸˜à¸µ merge: ${{ github.event.inputs.merge_method }}"

      # 1. à¸ªà¸±à¹ˆà¸‡ Merge PR
      - name: Merge Pull Request (Manual)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.inputs.pr_number }} \
            --${{ github.event.inputs.merge_method }} \
            --delete-branch

      # 2. [à¹„à¸¡à¹‰à¸•à¸²à¸¢] à¸„à¹‰à¸™à¸«à¸²à¹€à¸¥à¸‚ Issue à¹à¸¥à¹‰à¸§à¸ªà¸±à¹ˆà¸‡à¸›à¸´à¸”à¸—à¸±à¸™à¸—à¸µ
      - name: Force Close Linked Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” à¸à¸³à¸¥à¸±à¸‡à¸«à¸²à¹€à¸¥à¸‚ Issue à¸ˆà¸²à¸à¹€à¸™à¸·à¹‰à¸­à¸«à¸² PR..."
          
          # à¸”à¸¶à¸‡à¹€à¸™à¸·à¹‰à¸­à¸«à¸² Body à¸‚à¸­à¸‡ PR à¸¡à¸²à¸­à¹ˆà¸²à¸™
          PR_BODY=$(gh pr view ${{ github.event.inputs.pr_number }} --json body -q .body)
          
          # à¸„à¹‰à¸™à¸«à¸²à¹€à¸¥à¸‚à¸«à¸¥à¸±à¸‡à¸„à¸³à¸§à¹ˆà¸² "closes #" (à¹à¸à¸°à¹€à¸¥à¸‚à¸­à¸­à¸à¸¡à¸²)
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oE 'closes #[0-9]+' | grep -oE '[0-9]+' | head -n 1)

          if [ -n "$ISSUE_NUM" ]; then
            echo "âœ… à¹€à¸ˆà¸­à¹à¸¥à¹‰à¸§! Issue à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸›à¸´à¸”à¸„à¸·à¸­ #$ISSUE_NUM"
            
            # à¸ªà¸±à¹ˆà¸‡à¸›à¸´à¸” Issue à¸™à¸±à¹‰à¸™à¸‹à¸°!
            gh issue close $ISSUE_NUM --comment "Auto-closed by Robot Merge ðŸ¤–"
            echo "ðŸŽ‰ à¸›à¸´à¸”à¸‡à¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ Project Update à¹à¸¥à¹‰à¸§!"
          else
            echo "âš ï¸ à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¸„à¸³à¸§à¹ˆà¸² closes #... à¹ƒà¸™ PR à¸™à¸µà¹‰ à¹€à¸¥à¸¢à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸›à¸´à¸” Issue"
          fi