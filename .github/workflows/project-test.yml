name: Manual Add PR to Project (Test)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'เลข PR ที่ต้องการเพิ่ม (เช่น 77)'
        required: true
      project_number:
        description: 'เลข Project (เช่น 1)'
        required: true
        default: '1'

jobs:
  test_project_logic:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.MY_PROJECT_TOKEN }}
      # ใช้ตัวแปรกลางของ GitHub เพื่อหาชื่อเจ้าของ Repo อัตโนมัติ
      REPO: ${{ github.repository }}
      
    steps:
      # --- เพิ่มส่วนนี้เข้าไป ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR Node ID
        id: get_pr_id
        run: |
          # เพิ่ม --repo $REPO เพื่อระบุว่าต้องไปดูที่คลังเก็บโค้ดไหน
          PR_NODE_ID=$(gh pr view ${{ github.event.inputs.pr_number }} --repo $REPO --json id -q .id)
          echo "PR_ID=$PR_NODE_ID" >> $GITHUB_ENV
          echo "ใช้ PR ID: $PR_NODE_ID"

      - name: Get Project Data
        run: |
          # เปลี่ยนจาก user เป็น organization ถ้าคุณรันในนามทีม หรือลองใช้ user ตามเดิมถ้าเป็นโปรเจกต์ส่วนตัว
          # ในที่นี้ผมใช้ชื่อคุณ ing1403 ตามภาพ
          gh api graphql -f query='
            query($user: String!, $number: Int!) {
              user(login: $user){
                projectV2(number: $number) {
                  id
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2Field { id name }
                      ... on ProjectV2SingleSelectField { id name options { id name } }
                    }
                  }
                }
              }
            }' -f user=ing1403 -F number=${{ github.event.inputs.project_number }} > project_data.json

          echo 'PROJECT_ID='$(jq -r '.data.user.projectV2.id' project_data.json) >> $GITHUB_ENV
          echo 'STATUS_FIELD_ID='$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .id' project_data.json) >> $GITHUB_ENV
          echo 'TODO_OPTION_ID='$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .options[] | select(.name=="Todo") |.id' project_data.json) >> $GITHUB_ENV

      - name: Add PR to Project
        run: |
          item_id="$( gh api graphql -f query='
            mutation($project:ID!, $pr:ID!) {
              addProjectV2ItemById(input: {projectId: $project, contentId: $pr}) {
                item { id }
              }
            }' -f project=$PROJECT_ID -f pr=$PR_ID --jq '.data.addProjectV2ItemById.item.id')"
          echo 'ITEM_ID='$item_id >> $GITHUB_ENV

      - name: Update Status to Todo
        run: |
          gh api graphql -f query='
            mutation ($project: ID!, $item: ID!, $status_field: ID!, $status_value: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: $status_field
                value: { singleSelectOptionId: $status_value }
              }) { projectV2Item { id } }
            }' -f project=$PROJECT_ID -f item=$ITEM_ID -f status_field=$STATUS_FIELD_ID -f status_value=$TODO_OPTION_ID --silent