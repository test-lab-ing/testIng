name: Auto Create Pull Request and Merge PR
on:
  push:
    branches-ignore:
      - main
  
jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
      pull-requests: write
      statuses: write
    outputs:
      pr_number: ${{ steps.cpr_step.outputs.pr_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      # [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏Å‡∏∞‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Clean & Clear)
      - name: Extract Issue Number
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          # ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Branch
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -n 1)
          
          if [ -n "$ISSUE_NUM" ]; then
            echo "NUM=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "‚úÖ ‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç Issue: $ISSUE_NUM"
          else
            echo "NUM=" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç Issue"
          fi

      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á PR
      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.ref_name }}
          destination_branch: "main"
          pr_title: "PR: ‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì #${{ steps.extract.outputs.NUM }}"
          pr_body: |
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ GitHub Action 
            closes #${{ steps.extract.outputs.NUM }}
          github_token: ${{ secrets.GITHUB_TOKEN }}  
     
      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°?
      - name: Check for changes
        run: |
          if [ -z "${{ steps.cpr_step.outputs.pr_number }}" ]; then
            echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)"
            echo "‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Merge ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô"
          else
            echo "‚úÖ ‡∏û‡∏ö‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà! ‡∏™‡∏£‡πâ‡∏≤‡∏á PR ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${{ steps.cpr_step.outputs.pr_number }} ‡πÅ‡∏•‡πâ‡∏ß"
          fi

      # # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏±‡πà‡∏á Merge ‡πÅ‡∏•‡∏∞‡∏•‡∏ö Branch ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ üóëÔ∏è
      # - name: Merge Pull Request
      #   if: ${{ steps.cpr_step.outputs.pr_number }}
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     echo "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Merge PR ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${{ steps.cpr_step.outputs.pr_number }}..."
          
      #     # ‡πÄ‡∏û‡∏¥‡πà‡∏° --delete-branch ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Å‡∏¥‡πà‡∏á oil ‡∏ö‡∏ô GitHub ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô
      #     gh pr merge ${{ steps.cpr_step.outputs.pr_number }} --merge --auto --delete-branch